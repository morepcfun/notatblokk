<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notepad</title>
    <style>
        body {
            font-family: monospace;
            background-color: #121212;
            color: #eeeeee;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 1rem 0;
        }

        #toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            background: #181818;
            border-radius: 12px;
            padding: 10px 12px 6px 12px;
            max-width: 768px;
            width: 100%;
            margin-left: auto;
            margin-right: auto;
            margin-bottom: 0.5rem;
            justify-content: center;
            align-items: center;
            box-sizing: border-box;
            position: sticky;
            top: 1rem;
            z-index: 100;
            border: 1px solid #333;
        }

        #toolbar button {
            background: #232323;
            color: #eee;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 6px 16px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s, box-shadow 0.2s;
            min-width: 38px;
            min-height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
        }

        #toolbar button:hover {
            background: #333;
            box-shadow: 0 2px 8px 0 #0002;
        }

        #notepad {
            max-width: 768px;
            width: 100%;
            min-height: 70vh;
            padding: 20px;
            background-color: #222;
            border: 1px solid #444;
            color: #eee;
            font-size: 1rem;
            line-height: 1.5;
            border-radius: 14px;
            box-sizing: border-box;
            outline: none;
        }

        #notepad a {
            color: #7ecbff;
            text-decoration: underline;
            transition: color 0.2s;
        }

        #notepad a:hover {
            color: #b3e0ff;
        }

        #notepad pre {
            background: #111;
            border: 1px solid #333;
            padding: 1em;
            border-radius: 8px;
            white-space: pre-wrap;
            font-family: 'Courier New', Courier, monospace;
        }
    </style>
</head>

<body>

    <div id="opened-filename" style="width:100%; max-width:768px; margin:0 auto 6px auto; text-align:center; color:#7ecbff; font-size:0.95rem; display:none;">
    </div>

    <div id="toolbar">
        <button type="button" id="open-btn" title="Open file">üìÇ</button>
        <button type="button" id="save-btn" title="Save file (Ctrl+S)">üíæ</button>
        <button type="button" id="clear-btn" title="Clear notes">üóëÔ∏è</button>
        <button type="button" title="Bold (Ctrl+B)" onclick="format('bold')"><b>B</b></button>
        <button type="button" title="Italic (Ctrl+I)" onclick="format('italic')"><i>I</i></button>
        <button type="button" title="Underline (Ctrl+U)" onclick="format('underline')"><u>U</u></button>
        <button type="button" title="Strikethrough (Ctrl+D)" onclick="format('strikeThrough')"><s>S</s></button>
        <button type="button" title="Heading" onclick="formatBlock('h2')">H2</button>
        <button type="button" title="Code Block" onclick="formatBlock('pre')">&lt;/&gt;</button>
        <button type="button" title="Bulleted List" onclick="format('insertUnorderedList')">‚Ä¢ List</button>
        <button type="button" title="Numbered List" onclick="format('insertOrderedList')">1. List</button>
        <button type="button" title="Justify Left" onclick="format('justifyLeft')">L</button>
        <button type="button" title="Justify Center" onclick="format('justifyCenter')">C</button>
        <button type="button" title="Justify Right" onclick="format('justifyRight')">R</button>
        <button type="button" title="Link" onclick="insertLink()">üîó</button>
        <button type="button" title="Image" onclick="triggerImageUpload()">üñºÔ∏è</button>
        <input type="file" id="image-upload" accept="image/*" style="display:none">
        <button type="button" title="Undo (Ctrl+Z)" onclick="format('undo')">‚Ü∫</button>
        <button type="button" title="Redo (Ctrl+Y)" onclick="format('redo')">‚Üª</button>
        <button type="button" title="Clear Formatting" onclick="clearFormatting()">üßπ</button>
    </div>

    <div id="notepad" contenteditable="true" role="main"></div>

    <script>
        // --- DOM Elements ---
        const notepad = document.getElementById('notepad');
        const openBtn = document.getElementById('open-btn');
        const saveBtn = document.getElementById('save-btn');
        const clearBtn = document.getElementById('clear-btn');
        const imageUpload = document.getElementById('image-upload');
        const openedFilename = document.getElementById('opened-filename');
        let currentFilename = '';

        // --- Formatting Functions ---
        function format(command, value = null) {
            document.execCommand(command, false, value);
            notepad.focus();
        };

        function formatBlock(tag) {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                let container = selection.getRangeAt(0).commonAncestorContainer;
                // If the container is a text node, get its parent element
                if (container.nodeType === 3) {
                    container = container.parentNode;
                }
                // Check if the container is already the desired tag, and toggle it off if so
                if (container && container.closest && container.closest(tag)) {
                    document.execCommand('formatBlock', false, 'div');
                } else {
                    document.execCommand('formatBlock', false, tag);
                }
            }
            notepad.focus();
        };

        function insertLink() {
            let url = prompt('Enter URL:', 'https://');
            if (url) {
                format('createLink', url);
            }
        };

        function triggerImageUpload() {
            imageUpload.click();
        };
        
        function clearFormatting() {
            document.execCommand('removeFormat', false, null);
            notepad.focus();
        };

        // --- File and Image Handling ---
        function saveNotes() {
            const defaultName = currentFilename || 'my-notes.html';
            const fileName = prompt("Enter a filename for your note:", defaultName);
            if (!fileName) return;

            const content = notepad.innerHTML;
            const newHtml = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Note</title>
    <style>
        body { font-family: monospace; background-color: #121212; color: #eeeeee; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; }
        #notepad { max-width: 768px; width: 100%; padding: 20px; background-color: #222; border: 1px solid #444; color: #eee; font-size: 1rem; line-height: 1.5; border-radius: 14px; box-sizing: border-box; margin: 20px auto; }
        #notepad img { max-width: 100%; height: auto; display: block; margin: 8px 0; cursor: pointer; }
        #notepad a { color: #7ecbff; text-decoration: underline; transition: color 0.2s; }
        #notepad a:hover { color: #b3e0ff; }
        #notepad pre { background: #111; border: 1px solid #333; padding: 1em; border-radius: 8px; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="notepad">${content}</div>
    <script>
        // Allows images to be clicked to view full size in a new tab
        document.getElementById('notepad').addEventListener('click', function(e) {
            if (e.target.tagName === 'IMG' && e.target.src.startsWith('data:image')) {
                const imageData = e.target.src;
                const newPageContent = \`
<!DOCTYPE html>
<html>
    <head>
        <title>Full Size Image</title>
        <style>body{margin:0; background-color:#121212; display:flex; justify-content:center; align-items:center; height:100vh;} img{max-width:100%; max-height:100vh; object-fit:contain;}</style>
    </head>
    <body><img src="\${imageData}" alt="Full size image"></body>
</html>\`;
                const blob = new Blob([newPageContent], { type: 'text/html' });
                window.open(URL.createObjectURL(blob), '_blank');
            }
        });
    <\/script>
</body>
</html>`;
            const blob = new Blob([newHtml], {
                type: 'text/html'
            });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = fileName.endsWith('.html') ? fileName : `${fileName}.html`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function clearNotes() {
            if (confirm("Are you sure you want to clear the entire note? This cannot be undone.")) {
                notepad.innerHTML = '';
                localStorage.removeItem('webNotebookContent');
                openedFilename.style.display = 'none';
                openedFilename.textContent = '';
                currentFilename = '';
            }
        }

        function insertImageFromReader(event) {
            const tempImg = new Image();
            tempImg.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const maxWidth = 1920; // Max width for resizing
                const scaleFactor = tempImg.width > maxWidth ? maxWidth / tempImg.width : 1;

                canvas.width = tempImg.width * scaleFactor;
                canvas.height = tempImg.height * scaleFactor;

                ctx.drawImage(tempImg, 0, 0, canvas.width, canvas.height);
                
                // Compress the image as a JPEG for smaller file sizes
                const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
                const imgHtml = `<img src="${dataUrl}" style="max-width: 100%; height: auto; display: block; margin: 8px 0;">`;
                
                document.execCommand('insertHTML', false, imgHtml);
            };
            tempImg.src = event.target.result;
        }

        // --- Setup and Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            // Load content from localStorage on startup
            const savedContent = localStorage.getItem('webNotebookContent');
            if (savedContent) {
                notepad.innerHTML = savedContent;
            }

            saveBtn.onclick = saveNotes;
            clearBtn.onclick = clearNotes;

            // Open File
            openBtn.addEventListener('click', () => {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.html';
                fileInput.style.display = 'none';
                document.body.appendChild(fileInput);

                fileInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const content = event.target.result;
                        // Check if the file was created with this app
                        if (content.includes('<div id="notepad">')) {
                            const doc = new DOMParser().parseFromString(content, 'text/html');
                            const loadedNotepad = doc.getElementById('notepad');
                            notepad.innerHTML = loadedNotepad ? loadedNotepad.innerHTML : '';
                            currentFilename = file.name;
                            openedFilename.textContent = `Opened: ${file.name}`;
                            openedFilename.style.display = 'block';
                        } else {
                            alert("Cannot open the file. It was not created with this notepad.");
                        }
                    };
                    reader.readAsText(file);
                    document.body.removeChild(fileInput);
                });

                fileInput.click();
            });

            // Upload Image
            imageUpload.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = insertImageFromReader;
                reader.readAsDataURL(file);
                e.target.value = ''; // Reset input so the same file can be selected again
            });

            // Autosave to localStorage
            notepad.addEventListener('input', () => {
                localStorage.setItem('webNotebookContent', notepad.innerHTML);
            });

            // Keyboard Shortcuts
            notepad.addEventListener('keydown', (e) => {
                if (e.ctrlKey && !e.shiftKey) {
                    switch (e.key.toLowerCase()) {
                        case 'b': e.preventDefault(); format('bold'); break;
                        case 'i': e.preventDefault(); format('italic'); break;
                        case 'u': e.preventDefault(); format('underline'); break;
                        case 'd': e.preventDefault(); format('strikeThrough'); break;
                        case 's': e.preventDefault(); saveNotes(); break;
                        case 'z': e.preventDefault(); format('undo'); break;
                        case 'y': e.preventDefault(); format('redo'); break;
                    }
                }
            });

            // Handle pasting images
            notepad.addEventListener('paste', (e) => {
                const items = (e.clipboardData || window.clipboardData).items;
                for (const item of items) {
                    if (item.type.startsWith('image/')) {
                        e.preventDefault();
                        const blob = item.getAsFile();
                        const reader = new FileReader();
                        reader.onload = insertImageFromReader;
                        reader.readAsDataURL(blob);
                    }
                }
            });
        });
    </script>
</body>

</html>